from datetime import datetime

import requests

from constants import DANGER_LEVELS
from lib import logger


def fetch_vulnerabilities(api_url):
    """
    Request the wordfence API for vulnerabilities
    :param api_url: Api URL
    :return: Dictionary with vulnerabilities
    """
    logger.info("Fetching vulnerability from API")
    response = requests.get(api_url, timeout=30)
    response.raise_for_status()
    return response.json()


def match_vulnerabilities(api_data, sites, patched, min_danger, since_date):
    """
    Filter vulnerabilities based on danger level and date of found
    :param api_data: Wordfence api data
    :param sites: Dictionary of websites
    :param patched: True if extract must contain patched vulnerabilities false otherwise
    :param min_danger: Minimum danger level
    :param since_date: Minimum date to search for vulnerabilities
    :return: Dictionary with vulnerabilities
    """
    logger.info("Vulnerability analysis")
    results = {site: [] for site in sites}
    min_level = DANGER_LEVELS.get(min_danger, 1)

    for vuln_id, vuln in api_data.items():
        cvss = vuln.get("cvss", {})
        rating = cvss.get("rating", "Low")

        if DANGER_LEVELS.get(rating, 0) < min_level:
            continue

        published_str = vuln.get("published")
        if since_date and published_str:
            published = datetime.strptime(published_str, "%Y-%m-%d %H:%M:%S")
            if published < since_date:
                continue

        for software in vuln.get("software", []):
            if software.get("type") != "plugin":
                continue

            if not patched and software.get("patched", False):
                continue

            slug = software.get("slug")

            for site, data in sites.items():
                if slug in data["plugins"]:
                    results[site].append({
                        "id": vuln_id,
                        "title": vuln.get("title"),
                        "plugin": slug,
                        "severity": rating,
                        "patched": software.get("patched"),
                        "cve": vuln.get("cve"),
                        "url": vuln.get("references", [""])[0]
                    })

    return results
